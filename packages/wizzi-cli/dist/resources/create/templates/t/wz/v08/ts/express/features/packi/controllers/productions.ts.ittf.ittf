$group

    $
        var lp = '(';
    
    ${'$'}
        var ctrl = {
            name: 'Productions',
            path: '/api/v1/productions'
        }

    controller${lp} &ctrl )
        ${'$'}append imports
            import fs
                from 'fs'
            import 
                @ fsTypes
                from '../../filesystem'
            import 
                @ wizziTypes
                @ wizziProds
                @ WizziFactory
                from '../../wizzi'
            import 
                @ PackiFiles
                @ TemplateList
                @ Template
                from '../types'
            import 
                @ file
                from 'wizzi'
    
        _ this.router.post
            `lit 
                + /mtreedebuginfo/:id
            @ this.mTreeDebugInfo
        _ this.router.post
            `lit 
                + /artifact/:id
            @ this.generateArtifact
        _ this.router.post
            `lit 
                + /transform/:id/:transformer
            @ this.transformModel
        _ this.router.post
            `lit 
                + /job
            @ this.executeJob
        _ this.router.post
            `lit 
                + /wizzify
            @ this.wizzify

        ${'$'}append handlers

            handler${lp} mTreeDebugInfo )
                const id = request.params.id
                const files
                    :ref PackiFiles
                    = request.body
                log 'mTreeDebugInfo.received files', Object.keys(files)
                _ wizziProds.mTreeDebugInfo(id, files, {}).then
                    => 
                        param value
                        log 'debugInfo.result', value
                        _ sendSuccess
                            @ response
                            { 
                                @ mTreeBuildUpScript value
                    ._ catch
                        => 
                            param err
                            log 'features.packi.controllers.production.mTreeDebugInfo.err', err
                            _ sendFailure(response, err, 501)

            handler${lp} generateArtifact )
                const id = request.params.id
                const files
                    :ref PackiFiles
                    = request.body
                log 'generateArtifact.received files', Object.keys(files)
                _ wizziProds.generateArtifact(id, files).then
                    => 
                        param value
                        log 'generateArtifact.result', value
                        _ sendSuccess
                            @ response
                            { 
                                @ generatedArtifact value
                    ._ catch
                        => 
                            param err
                            log 'features.packi.controllers.production.generateArtifact.err', err
                            _ sendFailure(response, err, 501)
            
            handler${lp} transformModel )
                const id = request.params.id
                const transformer = request.params.transformer
                const files
                    :ref PackiFiles
                    = request.body
                log 'transformModel.received files', Object.keys(files)
                _ wizziProds.transformModel
                    @ id
                    @ files
                    {
                    {
                        @ transformer transformer
                    ._ then
                        => 
                            param value
                            log 'generateArtifact.result', value
                            _ sendSuccess
                                @ response
                                { 
                                    @ transformedModel value.transformResult
                    ._ catch
                        => 
                            param err
                            log 'features.packi.controllers.production.generateArtifact.err', err
                            _ sendFailure(response, err, 501)

            handler${lp} executeJob )
                const files
                    :ref PackiFiles
                    = request.body
                log 'ProductionsController.executeJob.received files', Object.keys(files)
                _ wizziProds.executeJobs(files).then
                    async=> 
                        param fsJson
                        const files
                            await 
                                _ WizziFactory.extractGeneratedFiles(fsJson)
                        log 'features.packi.controllers.production.executeJob.generatedArtifacts', Object.keys(files)
                        _ sendSuccess
                            @ response
                            { 
                                @ generatedArtifacts files
                    ._ catch
                        => 
                            param err
                            log 'features.packi.controllers.production.executeJob.err', err
                            _ sendFailure(response, err, 501)

            handler${lp} wizzify )
                const id = request.params.id
                const files
                    :ref PackiFiles
                    = request.body
                log 'wizzify.received files', Object.keys(files)
                _ wizziProds.wizzify(files).then
                    async=> 
                        param ittfResult
                            :ref PackiFiles
                        log 'features.packi.controllers.production.wizzify.ittfResult', ittfResult
                        _ sendSuccess
                            @ response
                            { 
                                @ packiResult ittfResult
                    ._ catch
                        => 
                            param err
                            log 'features.packi.controllers.production.wizzify.err', err
                            _ sendFailure(response, err, 501)


